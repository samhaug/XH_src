CPROG SNGINV
CXREF
      SUBROUTINE SNGINV(ITAPERI,ITERI)
      save
      DOUBLE PRECISION A,B,C,ERR,HOLD,DET,SOLUTN,DDAMP
      DIMENSION A(12,12),B(12),ERR(12),C(12),SYNT(514,10),
     1IPAR(10),SOLUTN(12),NAMES(10),SPEC(514)
      COMMON/PARAM/ NOTRCE,NOM4M5,NODEP,NOEPIC
      COMMON/DDAMP/DDAMP
      COMMON/TAPE/ SEIBUF(536),SYN7(514),FILLT(464)
      COMMON/DBLEC/ EPLA,EPLON,DEP,TORG,DURT
      COMMON/DBLEM/ XMD(6),R0D
      COMMON/BIGSPA/ SYNT,SPEC,FIL1B(5656),EIVECS(3,3),pad,
     1B,ERR,C,SOLUTN,IPAR,DDEP,DLAT,DLON,DT0,A,FIL2B(5958)
c pad added and FIL2B shortened to align double precision on double word
c boundaries
      EQUIVALENCE (SEIBUF(22),IFLAG),
     1(SEIBUF(3),INST),(SEIBUF(17),NFIRST),(SEIBUF(18),NEND)
      COMMON/OUTPAR/ ERRLA,ERRLO,ERRDEP,ERRTIM,
     1ERRMOM(6),SCALAR,STRIKE(2),DIP(2),SLIP(2),
     2EIVL(3),PLUNG(3),AZIM(3)
      EQUIVALENCE (SEIBUF(4),RATE)
      DATA NAMES/4H M1 ,4H M2 ,4H M3 ,4H M4 ,4H M5 ,4H M6 ,
     14HDDEP,4HDLAT,4HDLON,4HDTOR/,REPRAD/57.29578/
      ITAPER=ITAPERI
      ITER=ITERI
      WRITE(6,998) NODEP
  998 FORMAT('IN SNGINV NODEP = ',I2)
      DO 1 I=1,12
      B(I)=0.D0
      ERR(I)=0.D0
      SOLUTN(I)=0.D0
      IF(I.LE.10) IPAR(I)=0
      DO 1 J=1,12
    1 A(J,I)=0.D0
      DDEP=0.
      ERRDEP=0.
      DLAT=0.
      ERRLA=0.
      DLON=0.
      ERRLO=0.
      DT0=0.
      ERRTIM=0.
      DO 2 I=1,6
      IF(ITER.EQ.0) XMD(I)=0.
      ERRMOM(I)=0.
    2 CONTINUE
      NPAR=0
      IFACT=6
      IF(ITER.GT.0) IFACT=10
      DO 3 I=1,IFACT
      IF(I.GT.3) GO TO 4
      NPAR=NPAR+1
      IPAR(NPAR)=I
      GO TO 3
    4 IF(I.GT.5) GO TO 5
      IF(NOM4M5.GT.0) GO TO 3
      NPAR=NPAR+1
      IPAR(NPAR)=I
      GO TO 3
    5 IF(I.GT.6) GO TO 6
      NPAR=NPAR+1
      IPAR(NPAR)=I
      GO TO 3
    6 IF(ITER.EQ.0) GO TO 3
      IF(I.GT.7) GO TO 67
      IF(NODEP.GT.0) GO TO 3
      NPAR=NPAR+1
      IPAR(NPAR)=I
      GO TO 3
   67 IF(I.EQ.10) GO TO 68
      IF(NOEPIC.GT.0) GO TO 3
   68 NPAR=NPAR+1
      IPAR(NPAR)=I
    3 CONTINUE
      POINTS=0.
      SUM2=0.
      IF(ITER.EQ.0) RETURN
      DO 30 I=1,NPAR
      J=IPAR(I)
      IF(J.GT.6) GO TO 30
      SOLUTN(J)=XMD(J)
   30 CONTINUE
      RETURN
      ENTRY INPMTX(WATEI)
      WATE=WATEI
      IF(IFLAG.NE.0) RETURN
      IMIN=3
      IMAX=514
      IF(ITAPER.EQ.1) IMAX=366
      IF(RATE.GT.20.) IMAX=488
      RED=1.
      IF(ITAPER.EQ.1) RED=0.7111
C     IF(RATE.GT.20.) RED=0.948
      IF(RATE.GT.20.) RED=0.948
      IF(ITER.EQ.0) GO TO 774
      DO 775 I=IMIN,IMAX
  775 SPEC(I)=SPEC(I)-SYN7(I)
  774 POINTS=POINTS+FLOAT(NEND-NFIRST+1)*RED
      DO 20 KK=IMIN,IMAX
      SUM2=SUM2+WATE*SPEC(KK)**2
      DO 40 JK=1,NPAR
      I=IPAR(JK)
      FACT=SYNT(KK,I)*WATE
      HOLD=SPEC(KK)*FACT
      B(JK)=B(JK)+HOLD
      DO 21 JB=1,JK
      J=IPAR(JB)
      HOLD=FACT*SYNT(KK,J)
      A(JK,JB)=A(JK,JB)+HOLD
   21 CONTINUE
   40 CONTINUE
   20 CONTINUE
      RETURN
      ENTRY RESULT(IERR)
      IERR=0
      IF(ITER.EQ.0) SUM2OR=SUM2
      NEQ=NPAR
      IF(NOTRCE.EQ.0) GO TO 10
      NEQ=NEQ+1
      A(NEQ,1)=1.D0
      A(NEQ,2)=1.D0
      A(NEQ,3)=1.D0
   10 DO 12 I=1,NEQ
      DO 12 J=1,I
   12 A(J,I)=A(I,J)
      DO 15 I=1,NEQ
   15 WRITE(6,1009) I,(A(I,J),J=1,NEQ)
      WRITE(6,1010) (B(I),I=1,NEQ)
 1009 FORMAT(I3,12E10.3/(3X,12E10.3))
 1010 FORMAT(' B=',12E10.3/(3X,12E10.3))
c     OPEN(35,FILE='lu_35',FORM='FORMATTED',RECFM='DS',PAD='YES')
c     OPEN(35,FILE='lu_35',FORM='FORMATTED')
      rewind 35
      WRITE(35,'(''NPAR='',I10)')NPAR
      DO I=1,NPAR
        WRITE(35,'(5X,I10)') IPAR(I)
      ENDDO
      WRITE(35,'(''SUM2='',E20.10)')SUM2
      WRITE(35,'(''SU2O='',E20.10)')SUM2OR
      DO I=1,NPAR
        DO J=1,NPAR
          WRITE(35,'(''ATA  '',D20.10)') A(J,I)
        ENDDO
      ENDDO
      DO I=1,NPAR
        WRITE(35,'(''ATB  '',D20.10)') B(I)
      ENDDO
      DO I=1,6
        WRITE(35,'(''SOLU '',E20.10)') SOLUTN(I)
      ENDDO
      WRITE(35,'(''EPLA '',E20.10)')EPLA
      WRITE(35,'(''EPLO '',E20.10)')EPLON
      WRITE(35,'(''DEP  '',E20.10)')DEP
      WRITE(35,'(''TORG '',E20.10)')TORG
      WRITE(35,'(''DURT '',E20.10)')DURT
c      CLOSE(35)


C     WRITE(14,REC=1) NSOUR,NPAR,NEQ,SUM2OR
C    1   ,((XMD(I,J),I=1,6),J=1,3),((IPAR(I,J),J=1,10),I=1,3)
C     DO 112 I=1,NEQ
C 112 WRITE(14)(A(J,I),J=1,NEQ)
C     WRITE(14) (B(I),I=1,NEQ)
      CALL MATINV(A,NEQ,12,DET)
      DO 113 I=1,NPAR
      C(I)=0.D0
      DO 13 J=1,NPAR
   13 C(I)=C(I)+A(I,J)*B(J)
  113 SUM2=SUM2-B(I)*C(I)
C     WRITE(14) (C(I),I=1,NPAR)
      HOLD=SUM2/POINTS
      DO 22 I=1,NPAR
      KJ=IPAR(I)
      ERR(KJ)=DSQRT(A(I,I)*HOLD)
   22 SOLUTN(KJ)=SOLUTN(KJ)+C(I)
      RAT=SUM2/SUM2OR
      IF(ITER.EQ.0) WRITE(16,3004)
      WRITE(6,1100) RAT
      WRITE(16,1100) RAT
 1100 FORMAT(' R.M.S. RATIO',F10.5)
      WRITE(16,1000) ITER
      WRITE(6,1000) ITER
 1000 FORMAT(' ITERATION',I2)
      DO 847 I=1,NPAR
      J=IPAR(I)
      IF(J.GT.6) GO TO 847
      XMD(J)=SOLUTN(J)
      ERRMOM(J)=ERR(J)
  847 CONTINUE
      DO 14 I=1,IFACT
      DO 24 K=1,NPAR
      IF(I.EQ.IPAR(K)) GO TO 25
   24 CONTINUE
      GO TO 14
   25 WRITE(16,1001) NAMES(I),SOLUTN(I),ERR(I)
      WRITE(6,1001) NAMES(I),SOLUTN(I),ERR(I)
 1001 FORMAT(1X,A4,2D13.5,4X)
      IF(I.EQ.7) DDEP=-SOLUTN(I)*6371.*DDAMP
      IF(I.EQ.7) ERRDEP=ERR(I)*6371.
      IF(I.NE.7) GO TO 573
      WRITE(6,788) DEP,DDEP,NODEP
  788 FORMAT('IN SNGINV DEP = ',F10.1,' DDEP = ',F10.1,' NODEP = ',I2)
      IF(DEP+DDEP.GT.14.99) GO TO 573
      WRITE(6,574)
      WRITE(16,574)
  574 FORMAT(' DEPTH BECOMING LESS THAN 15KM'/
     1' SOLUTION CONSTRAINED TO THE VALUE FROM PRECEDING ITERATION')
      NODEP=1
      IERR=1
      RETURN
  573 IF(I.EQ.8) DLAT=-SOLUTN(I)*REPRAD/R0D
      IF(I.EQ.8) ERRLA=ERR(I)*REPRAD/R0D
      IF(I.EQ.9) DLON=SOLUTN(I)*REPRAD/(R0D*COS(EPLA/REPRAD))
      IF(I.EQ.9) ERRLO=ERR(I)*REPRAD/(R0D*COS(EPLA/REPRAD))
      IF(I.EQ.10) DT0=SOLUTN(I)
      IF(I.EQ.10) ERRTIM=ERR(I)
   14 CONTINUE
      EPLA=EPLA+DLAT
      EPLON=EPLON+DLON
      DEP=DEP+DDEP
      TORG=TORG+DT0
      CALL SOURPA(XMD,SCALAR,STRIKE,DIP,SLIP,EIVL,PLUNG,AZIM,EIVECS)
      WRITE(6,1002) NAMES(7),DDEP,NAMES(8),DLAT,
     1NAMES(9),DLON,NAMES(10),DT0
      WRITE(16,1002) NAMES(7),DDEP,NAMES(8),DLAT,
     1NAMES(9),DLON,NAMES(10),DT0
 1002 FORMAT(' PERT. IN HYPOC.',2X,4(1X,A4,F7.3))
      WRITE(6,1004)
      WRITE(16,1004)
 1004 FORMAT(' COORDINATES AFTER INVERSION')
      WRITE(6,1005) DEP
      WRITE(16,1005) DEP
 1005 FORMAT(' DEPTH',6X,F10.3)
      WRITE(6,1006) EPLA
      WRITE(16,1006) EPLA
 1006 FORMAT(' LATITUDE',3X,F10.3)
      WRITE(6,1007) EPLON
      WRITE(16,1007) EPLON
 1007 FORMAT(' LONGITUDE',2X,F10.3)
      WRITE(6,1008) TORG
      WRITE(16,1008) TORG
 1008 FORMAT(' ORIGIN TIME',F10.3)
      WRITE(16,3003)
 3003 FORMAT(1H /)
c3003 FORMAT(1H1/////)
      CALL PPFP(16,5,1,EIVECS)
c     CALL PPFP(16,8,26,EIVECS)
      WRITE(16,3004)
c3004 FORMAT(1H1//)
 3004 FORMAT(1H//)
      RETURN
      END
