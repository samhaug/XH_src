      SUBROUTINE ISCAN(IFCOM,ITAPER)
      save
      COMPLEX CSPEC
      CHARACTER*12 HETMDL
      INTEGER*4 IHTMDL(3)
      COMMON/SCAN/ NSOUR,NPATH,NPREC(3,50),NOGOOD(50),RATIOI,RATIOM
     1  ,IHTMDL,IFANM,LMAXM,LENY,NPRMM,PERTM(588),IFCC,MFIL(4),MFILAN(4)
      COMMON/BIGSPA/ FILLB(1536),ISTOR0(200),ISTOR1(200),
     1IFL(10),ARRAY(1401),DATA(514),FILLB2(13815)
      DIMENSION CSPEC(257),B(536),SPEC(514),COMP(514)
      EQUIVALENCE (B(1),ARRAY(1)),(B(1),ID),(B(3),INST),(B(4),RATE),
     1(B(16),DELAY),(B(17),NF),(B(18),NEND),(B(19),DELTA),
     2(B(20),AZEP),(B(21),AZST),(B(22),IFLAG),(B(23),SPEC(1)),
     3(B(16),IDELAY),(SPEC(1),CSPEC(1)),(COMP(1),ARRAY(537)),
     4(B(2),ICP)
      DIMENSION IT1(2),IT2(2)
      DATA IT1,IT2/137,205,183,257/
      DATA DOMEGI/0.0001917476/
      DATA MAXLEN/588/
      M=514
      NSOUR=1
      JT1=IT1(ITAPER)
      JT2=IT2(ITAPER)
      IF(IFCOM.NE.0) CALL BFFIN(2,1,NSOUR,1,J,M)
      CALL BFFOUT(7,1,NSOUR,1,J)
      NW=11*NSOUR+1
      IF(IFCOM.NE.0) CALL BFFIN(2,1,B,NW,J,M)
      CALL BFFOUT(7,1,B,NW,J)
      DO 3 I=537,1401
    3 ARRAY(I)=0.
      NT=2*JT2
      NT1=NT+1
      KNTS=0
      PS=0.
      REDB=1.
      IF(ITAPER.EQ.1) REDB=.711
      REDM=.948
      KNTM=0
      PM=0.
      KNTI=0
      PI=0.
      SUMS=0.
      SUMI=0.
      SUMM=0.
      CALL STSORT(NPATH,NPREC,ISTOR0,ISTOR1)
      KNT=0
      DO 100 NN=1,NPATH
      NOT=1
      NOGOOD(NN)=0
      NR=NPREC(1,NN)
      DO 87 I=1,10
   87 IFL(I)=-1
      DO 10 N=1,NR
      KNT=KNT+1
      IREC=ISTOR0(KNT)
      CALL BFFI(1,1,B,2144,J,M,IREC)
      IREC=ISTOR1(KNT)
      IF(IFCOM.NE.0) CALL BFFI(2,1,COMP,2056,J,M,IREC)
      IF(RATE.GT.20.) GO TO 200
      IFL(ICP)=IFLAG
      KNTS=KNTS+1
      PS=PS+FLOAT(NEND-NF+1)
      CALL TAPCLR(SPEC,DATA,NF,NEND,JT1,JT2,SUM2)
      SUMS=SUMS+SUM2
      CALL BFFOUT(7,1,ARRAY,1401,J)
      IF(IFLAG.EQ.0) NOT=0
      GO TO 10
  200 IF(RATE.GT.40.) GO TO 11
      NF=NF/2+1
      NEND=NEND/2+1
      RATE=64.
      DO 7 I=245,514
    7 SPEC(I)=0.
      CALL RFOUR(SPEC,7,-1)
      NEP1=NEND+1
      DO 8 I=NEP1,514
    8 SPEC(I)=0.
      CALL RFOUR(SPEC,8,1)
      IF(IFCOM.EQ.0) GO TO 11
      CALL RFOUR(COMP,7,-1)
      CALL CLEAR(NF,NEND,514,COMP)
      CALL RFOUR(COMP,8,1)
   11 IFL(ICP+5)=IFLAG
      IF(IFLAG.EQ.0) NOT=0
      JDELAY=IFIX(DELAY+32.)/64
      SHFT=64.*FLOAT(JDELAY)-DELAY
      IDELAY=JDELAY
      DO 51 I=2,257
      ARG=SHFT*FLOAT(I-1)*DOMEGI
   51 CSPEC(I)=CSPEC(I)*CMPLX(COS(ARG),SIN(ARG))
      CALL TAPCLR(SPEC,DATA,NF,NEND,182,244,SUM2)
      IF(INST.EQ.3) KNTI=KNTI+1
      IF(INST.EQ.3) PI=PI+FLOAT(NEND-NF+1)
      IF(INST.NE.3) KNTM=KNTM+1
      IF(INST.NE.3) PM=PM+FLOAT(NEND-NF+1)
      IF(INST.EQ.3) SUMI=SUMI+SUM2
      IF(INST.NE.3) SUMM=SUMM+SUM2
      CALL BFFOUT(7,1,ARRAY,1401,J)
      DO 93 I=6,10
      IF(IFL(I).NE.0) GO TO 93
      NPREC(3,NN)=1
   93 CONTINUE
   10 CONTINUE
      IF(NOT.NE.0) NOGOOD(NN)=1
      CALL STATN(ID,NAME,INST,STLAT,STLONG,ILEV)
      WRITE(16,1000) NN,NAME,DELTA,AZEP,AZST,INST,(IFL(I),I=1,10)
 1000 FORMAT(1X,I2,1X,A4,3F10.3,I5,5X,2(5I3,5X))
  100 CONTINUE
C
C      WRITE THE PATH PARAMETERS
C
      CALL REWFL(7)
      RATIOI=0.
      RATIOM=0.
      AVSRO=0.
      AVIDA=0.
      AVMNT=0.
      IF(KNTS.NE.0) AVSRO=SQRT(SUMS/(REDB*PS))
      IF(KNTI.NE.0) AVIDA=SQRT(SUMI/(PI*REDM))
      IF(KNTM.NE.0) AVMNT=SQRT(SUMM/(PM*REDM))
      IF(AVMNT.NE.0.) RATIOM=AVSRO/AVMNT
      IF(AVIDA.NE.0.) RATIOI=AVSRO/AVIDA
      IF(AVSRO.EQ.0..AND.AVIDA.NE.0.) RATIOI=AVMNT/AVIDA
      IF(KNTS.NE.0) WRITE(6,1002) KNTS
 1002 FORMAT(I4,' LONG-PERIOD BODY-WAVE RECORDS')
      IF(KNTM.NE.0) WRITE(6,1001) KNTM,RATIOM
 1001 FORMAT(I4,' GDSN MANTLE WAVE RECORDS, AMPLITUDE RATIO ',E10.3)
      IF(KNTI.NE.0) WRITE(6,1003) KNTI,RATIOI
 1003 FORMAT(I4,' IDA MANTLE WAVE RECORDS, AMPLITUDE RATIO ',E10.3)
      CALL CLOSFL(1,ISTAT)
      CALL CLOSFL(2,ISTAT)
      IFCC=0
      HETMDL='            '
      READ(HETMDL,111) IHTMDL
  111 FORMAT(3A4)
      IFANM=0
      LMAXM=0
      LENY=0
      NPRMM=0
      DO 92 I=1,MAXLEN
   92 PERTM(I)=0.
      CALL BFFOUT(7,1,NSOUR,808,J)
      CALL REWFL(7)
      RETURN
      END
