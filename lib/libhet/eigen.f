
C$**********************************************************************
      SUBROUTINE EIGEN(Q,V,N,JVEC)
      save
C
C     COMPUTES EIGENVALUES AND EIGENVECTORS OF A REAL SYMMETRIC MATRIX
C         USING JACOBI DIAGONALIZATION
C
C     Q=SYMMETRIC MATRIX - DESTROYED DURING COMPUTATION AND REPLACED BY
C        A MATRIX WITH EIGENVALUES ALONG DIAGONAL
C     V=MATRIX OF EIGENVECTORS -  ORDER CORRESPONDS TO EIGENVALUES ALONG
C        DIAGONAL OF Q
C     N=ORDER OF Q AND V, N  GREATER OR EQUAL 2
C     JVEC=0 TO COMPUTE EIGENVALUES ONLY
C         =NON-ZERO INTEGER TO COMPUTE EIGENVALUES AND EIGENVECTORS
C
      DIMENSION Q(3,3),V(3,3),X(3),IH(3)
C
C      SET INITIAL VALUES OF V
C
      IF(JVEC) 10,15,10
   10 DO 14 I=1,N
      DO 14 J=1,N
      IF(I-J) 12,11,12
   11 V(I,J)=1.0
      GOTO 14
   12 V(I,J)=0.0
   14 CONTINUE
   15 M=0
C
C     SCAN FOR LARGEST OFF DIAGONAL ELEMENT IN EACH ROW
C     X(I) CONTAINS LARGEST ELEMENT IN ITH ROW
C     IH(I) HOLDS SECOND SUBSCRIPT DEFINING POSITION OF ELEMENT
C
      MI=N-1
      DO 30 I=1,MI
      X(I)=0.0
      MJ=I+1
      DO 30 J=MJ,N
      IF(X(I)-ABS(Q(I,J))) 20,20,30
   20 X(I)=ABS(Q(I,J))
      IH(I)=J
   30 CONTINUE
C
C     SEARCH FOR MAXIMUM OF X(I)'S FOR PIVOT ELEMENT
C
   40 DO 70 I=1,MI
      IF(I-1) 60,60,45
   45 IF(XMAX-X(I)) 60,70,70
   60 XMAX=X(I)
      IP=I
      JP=IH(I)
   70 CONTINUE
C
C     TEST FOR XMAX, IF LESS THAN 10**-8 GOTO 1000
C
      EPSI=1.0E-8
      IF(XMAX-EPSI) 1000,1000,148
  148 M=M+1
C
C     COMPUTE TANG,SIN,COS,Q(I,I),Q(J,J)
C
      IF(Q(IP,IP)-Q(JP,JP)) 150,151,151
  150 TANG=-2.*Q(IP,JP)/(ABS(Q(IP,IP)-Q(JP,JP))+SQRT((Q(IP,IP)-Q(JP,JP
     1))**2+4.*Q(IP,JP)**2))
      GOTO 160
  151 TANG=+2.*Q(IP,JP)/(ABS(Q(IP,IP)-Q(JP,JP))+SQRT((Q(IP,IP)-Q(JP,JP
     1))**2+4.*Q(IP,JP)**2))
  160 COSN=1.0/SQRT(1.0+TANG**2)
      SINE=TANG*COSN
      QII=Q(IP,IP)
      Q(IP,IP)=COSN**2*(QII+TANG*(2.*Q(IP,JP)+TANG*Q(JP,JP)))
      Q(JP,JP)=COSN**2*(Q(JP,JP)-TANG*(2.*Q(IP,JP)-TANG*QII))
      Q(IP,JP)=0.0
C
C     PSEUDO RANK THE EIGENVALUES
C
      IF(Q(IP,IP)-Q(JP,JP)) 152,153,153
  152 TEMP=Q(IP,IP)
      Q(IP,IP)=Q(JP,JP)
      Q(JP,JP)=TEMP
C
C     ADJUST SIN AND COS FOR COMPUTATION OF Q(I,K) AND V(I,K)
C
      IF(SINE) 154,155,155
  154 TEMP=COSN
      GOTO 170
  155 TEMP=-COSN
  170 COSN=ABS(SINE)
      SINE=TEMP
C
C     INSPECT THE IH'S BETWEEN I+1 AND N-1 TO DETERMINE WHETHER A NEW MAXIMUM
C     VALUE SUOULD BE COMPUTED SINCE THE PRESENT MAXIMUM IS IN THE I OR J ROW
C
  153 DO 350 I=1,MI
      IF(I-IP) 210,350,200
  200 IF (I-JP) 210,350,210
  210 IF(IH(I)-IP) 230,240,230
  230 IF(IH(I)-JP) 350,240,350
  240 K=IH(I)
      TEMP=Q(I,K)
      Q(I,K)=0.0
      MJ=I+1
      X(I)=0.0
C
C     SEARCH FOR NEW MAXIMUM IN DEPLETED ROW
C
      DO 320 J=MJ,N
      IF(X(I)-ABS(Q(I,J))) 300,300,320
  300 X(I)=ABS(Q(I,J))
      IH(I)=J
  320 CONTINUE
      Q(I,K)=TEMP
  350 CONTINUE
      X(IP)=0.0
      X(JP)=0.0
C
C     CHANGE THE OTHER ELEMENTS OF Q
C
      DO 530 I=1,N
      IF(I-IP) 370,530,420
  370 TEMP=Q(I,IP)
      Q(I,IP)=COSN*TEMP+SINE*Q(I,JP)
      IF(X(I)-ABS(Q(I,IP))) 380,390,390
  380 X(I)=ABS(Q(I,IP))
      IH(I)=IP
  390 Q(I,JP)=-SINE*TEMP+COSN*Q(I,JP)
      IF(X(I)-ABS(Q(I,JP))) 400,530,530
  400 X(I)=ABS(Q(I,JP))
      IH(I)=JP
      GOTO 530
  420 IF(I-JP) 430,530,480
  430 TEMP=Q(IP,I)
      Q(IP,I)=COSN*TEMP+SINE*Q(I,JP)
      IF(X(IP)-ABS(Q(IP,I))) 440,450,450
  440 X(IP)=ABS(Q(IP,I))
      IH(IP)=I
  450 Q(I,JP)=-SINE*TEMP+COSN*Q(I,JP)
      IF(X(I)-ABS(Q(I,JP))) 400,530,530
  480 TEMP=Q(IP,I)
      Q(IP,I)=COSN*TEMP+SINE*Q(JP,I)
      IF(X(IP)-ABS(Q(IP,I))) 490,500,500
  490 X(IP)=ABS(Q(IP,I))
      IH(IP)=I
  500 Q(JP,I)=-SINE*TEMP+COSN*Q(JP,I)
      IF(X(JP)-ABS(Q(JP,I))) 510,530,530
  510 X(JP)=ABS(Q(JP,I))
      IH(JP)=I
  530 CONTINUE
C
C     TEST FOR COMPUTATION OF EIGENVECTORS
C
      IF(JVEC) 540,40,540
  540 DO 550 I=1,N
      TEMP=V(I,IP)
      V(I,IP)=COSN*TEMP+SINE*V(I,JP)
  550 V(I,JP)=-SINE*TEMP+COSN*V(I,JP)
      GOTO 40
 1000 RETURN
      END
