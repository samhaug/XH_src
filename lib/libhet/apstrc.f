
C$**********************************************************************
CPROG APSTRC
CXREF
      SUBROUTINE APSTRC(ITAPER,NITER,IFSTOR,KPAR)
      save
      INTEGER*2 JJPAR(16)
      INTEGER*4 IHTMDL(3)
      DIMENSION AAP1(26)
      REAL KERBUF
      DOUBLE PRECISION PRDSUM,COLSUM
      COMPLEX EPTRYG,RESP,ASRINS,SROINS,RSPIDA,TAPER
C     INTEGER*2 JSTAT,JTYPE,JCOMP,JFACT,JTER,JNEIG,JPOINT,JIFDEP,
C    1JNSTR,JTRANS,J1S,J1F,J2S,J2F,JNPAR,JIFTWO
      INTEGER*4 JSTAT,JTYPE,JCOMP,JFACT,JTER,JNEIG,JPOINT,JIFDEP,
     1JNSTR,JTRANS,J1S,J1F,J2S,J2F,JNPAR,JIFTWO
      COMMON/INTAP/ JSTAT,JTYPE,JCOMP,JFACT,JTER,JNEIG,JPOINT,JIFDEP,
     1JNSTR,JTRANS,J1S,J1F,J2S,J2F,JNPAR,JIFTWO
      COMMON/AP1/ T0,DT,OMMAX,DELTA,CAZ,SAZ,EPTRYG(4),F(6),F2PF3,
     1F2MF3,R0,DOM,DTORG,DURTN
      COMMON/AP3/ DELT1,FACTT,FACTO,PPERT(24)
      COMPLEX RESP5
      COMMON/IAP6/ RESP5(257,5)
      COMMON/AP2/ BKERN(8740)
      COMMON/IAP5/ SKERN(12850)
      DIMENSION TEMBUF(326)
      COMMON/BIGSPA/  KERBUF(8740),RESP(257,5),PRTADD(24)
     1  ,COLSUM(24),
     1PRDSUM(300),TMPPRD(300),TMPCOL(24),VAR,RMS,ACCUM(24),FILLB(5344)
      EQUIVALENCE (TEMBUF(1),TMPPRD(1))
      DIMENSION BUFTEM(325)
      COMMON/TAPE/ B(536),COMP(514),NPAR,NSOL,PERT(24),PRDMTX(300),
     1COLVEC(24),VAR2,FILLT(112),NBATCH
      EQUIVALENCE (BUFTEM(1),PRDMTX(1))
      COMMON/DBLEM/ XMD(6),R0D
      COMMON/DBLEC/ EPLA,EPLON,DEP,TORG,DURT
      DIMENSION IT1(2),IT2(2),OBSEI(514)
      COMMON/SCAN/ NSOUR,NPATH,NPREC(3,50),NOGOOD(50),RATIOI,RATIOM
     1  ,IHTMDL,IFANM,LMAXM,LENY,NPRMM,PERTM(588),IFCC,MFIL(4),MFILAN(4)
      EQUIVALENCE (B(1),ID),(B(2),LCOMP),(B(3),INST),(B(4),RATE),
     1(B(7),IYEAR),(B(15),IDAY),(B(16),IDELAY),(B(17),NFIRST),
     2(B(18),NEND),(B(22),IFLAG),(B(23),OBSEI(1))
      EQUIVALENCE (B(19),DEL0),(B(20),AZEP0),(B(21),AZST0)
      EQUIVALENCE (AAP1(1),T0),(JSTAT,JJPAR(1))
C     INTEGER*2 I2_1,I2_2570,I2_2,I2_514,I2_26,I2_27,I2_16
C    1   ,I2_8740,I2_326,I2_325
C     DATA I2_1,I2_2570,I2_2,I2_514,I2_26,I2_27,I2_16
C    1   ,I2_8740,I2_326,I2_325/1,2570,2,514,26,27,16,8740
C    1   ,326,325/
C     INTEGER*2 IAINT,IAIAP6,IAAP1,IAAP2,IAAP3,IADDR
C
      DATA IT1,IT2,DOMIDA,DOMSRO/137,205,183,257,0.0001917476,
     10.0007669904/
C
C      AP ADDRESS OF INTEGER ARRAY /APINT/
C
C     IAINT=50
C
C      AP ADDRESS OF COMMON WITH F.P. MAIN PARAMETERS /AP1/
C
C     IAAP1=66
C
C      AP ADDRESS OF COMMON WITH MODAL PARAMETERS /AP2/
C
C     IAAP2=92
C
C      AP ADDRESS OF COMMON WITH STRUCTURE PERTURBATION /AP3/
C
C     IAAP3=8832
C
C      AP ADDRESS OF COMMON WITH 5 INSTRUMENTAL RESPONSES /IAP6/
C      1: IDA, 2: SRO-MV, 3: ASRO-MV, 4: SRO-BV, 5: ASRO-BV.
C
C     IAIAP6=8859
C
C      INITIALIZE AP
C
      JSTAT=-2
C     CALL APPUT(JSTAT,IAINT,I2_1,I2_1)
C     CALL APWD
C     CALL HROOT
      CALL MODES
C     CALL APWR
C
C      CALCULATE 4 OF THE 5 RESPONSES. THE IDA RESPONSE (FIRST) IS
C      CALCULATED, WHEN NECESSARY, LATER IN THE PROGRAM
C
      ZZERO=0.
      RESP(1,1)=ASRINS(ZZERO,0)
      DO 1 N=1,5
      DO 1 I=1,257
    1 RESP(I,N)=(0.,0.)
      DO 2 I=2,244
      OM=FLOAT(I-1)*DOMIDA
      FACT=-1./(OM*OM)
      RESP(I,2)=CMPLX(FACT,0.)*SROINS(OM)
      RESP(I,3)=CMPLX(FACT,0.)*ASRINS(OM,1)
    2 CONTINUE
      I2=IT2(ITAPER)
      I1=IT1(ITAPER)
      DO 3 I=2,I2
      OM=FLOAT(I-1)*DOMSRO
      FACT=-1./(OM*OM)
      RESP(I,4)=CMPLX(FACT,0.)*SROINS(OM)
      RESP(I,5)=CMPLX(FACT,0.)*ASRINS(OM,1)
    3 CONTINUE
C
C      SEND THE RESPONSES TO AP
C
C     CALL APPUT(RESP,IAIAP6,I2_2570,I2_2)
      DO 1250 I=1,257
      DO 1250 J=2,5
 1250 RESP5(I,J)=RESP(I,J)
      CALL EPCNTR(EPLA,EPLON)
      DO 17 I=1,6
   17 F(I)=XMD(I)
      F2PF3=F(2)+F(3)
      F2MF3=F(2)-F(3)
      R0=R0D
      DTORG=TORG
      DURTN=DURT
C
C      MAIN LOOP FOR ALL PATHS
C
      DO 800 NNN=1,NPATH
      IF(NOGOOD(NNN).NE.0) GO TO 800
C      NUMBER OF RECORDS
      NREC=NPREC(1,NNN)
C      DISK ADDRESS OF THE FIRST RECORD FOR THIS PATH
      IREC=NPREC(2,NNN)
C      FLAG FOR EXISTENCE OF AT LEAST ONE RECORD WITH MANTLE WAVES
      IFGTCR=NPREC(3,NNN)
      NSOL=KPAR
      IF(IFGTCR.NE.0) NSOL=2*KPAR
      CALL BFFI(7,1,B,5604,J,M,IREC)
      DO 276 I=1,24
      ACCUM(I)=PERT(I)
  276 CONTINUE
      IF(IFSTOR.EQ.0) CALL REINIT(ACCUM,KPAR)
C
C      LOOP FOR NITER ITERATIVE SOLUTIONS FOR PATH PERURBATION;
C      ONLY THE SYNTHETIC SEISMOGRAM IS COMPUTED IN LAST ITERATION
C
      DO 810 KK=1,NITER
      DO 4 I=1,300
    4 PRDSUM(I)=0.D0
      DO 5 I=1,24
    5 COLSUM(I)=0.D0
C
C      LOOP FOR RECORDS IN EACH PATH
C
      DO 700 NN=1,NREC
      JREC=IREC+NN-1
      CALL BFFI(7,1,B,5604,J,M,JREC)
      NPAR=KPAR
      NSOL=NPAR
      IF(IFGTCR.NE.0) NSOL=2*NPAR
      IF(IFLAG.NE.0.AND.KK.NE.NITER) GO TO 700
      CALL STATN(ID,NAME,INST,STALAT,STLONG,ILEV)
      CALL ANGLES(STALAT,STLONG,DELTA,AZEP,AZST,THETA,PHI,PSI,AZ12)
      REPRAD=180./3.1415926
      DEL1=REPRAD*DELTA
      AZEP1=AZEP*REPRAD
      AZST1=AZST*REPRAD
      THETA1=THETA*REPRAD
      PHI1=PHI*REPRAD
      PSI1=PSI*REPRAD
      CZ=COS(AZST)
      SZ=SIN(AZST)
      GO TO(21,22,23,24,25),LCOMP
   21 CAZ=-1.
      SAZ=0.
      GO TO 26
   22 CAZ=CZ
      SAZ=SZ
      GO TO 26
   23 CAZ=SZ
      SAZ=-CZ
      GO TO 26
   24 CAZ=-1.
      SAZ=0.
      GO TO 26
   25 CAZ=0.
      SAZ=-1.
   26 DO 18 I=1,4
      XM=FLOAT(I-1)*(3.1415926536-AZEP)
   18 EPTRYG(I)=CMPLX(COS(XM),SIN(XM))
      DT=RATE
      I1S=NFIRST-MIN0(10,NFIRST-1)
      J1S=I1S
      IF(RATE.GT.20.) GO TO 12
      DOM=DOMSRO
      JTRANS=8
      OMMAX=0.1396263
      IF(ITAPER.EQ.2) OMMAX=0.1963495
      IDELAY=0
      J2S=NEND+10
      IF(INST.EQ.3) STOP 'WRONG RATE'
      IF(INST.EQ.2) JNSTR=5
      IF(INST.NE.2) JNSTR=4
      GO TO 13
   12 DOM=DOMIDA
      JTRANS=8
      OMMAX=0.0465421
      J2S=NEND+MIN0(10,514-NEND)
      IF(INST.NE.3) GO TO 14
      DO 15 I=2,257
      OM=FLOAT(I-1)*DOMIDA
C     RESP(I,1)=RSPIDA(IDAY,IYEAR+1900,NAME,OM,I)
      CALL IDARESP(RESP(I,1),IDAY,IYEAR+1900,NAME,OM,I)
   15 CONTINUE
C
C      STORE IDA RESPONSE IN AP
C
C     CALL APPUT(RESP,IAIAP6,I2_514,I2_2)
      DO 1251 I=1,257
 1251 RESP5(I,1)=RESP(I,1)
      JNSTR=1
      GO TO 13
   14 IF(INST.EQ.2) JNSTR=3
      IF(INST.NE.2) JNSTR=2
   13 T0=RATE*FLOAT(IDELAY+I1S-1)
C
C      COMMON /AP1/ COMPLETE, SEND IT.
C
C     CALL APPUT(T0,IAAP1,I2_26,I2_2)
C       COMMON /AP1/ ALREADY SHARED
      J1F=NFIRST
      J2F=NEND
      JCOMP=LCOMP
      JFACT=1
      IF(KK.EQ.NITER.AND.NITER.NE.1) JFACT=0
      JPOINT=J2S-J1S+1
      JNPAR=KPAR
      JIFTWO=0
      IF(RATE.GT.20.) JIFTWO=1
      COT2T=COS(2.*THETA)
      S2T=0.5*(1.-COT2T)
      C2T=0.5*(1.+COT2T)
      FACTT=-3.*SIN(DELTA)*COS(AZ12)*S2T
      FACTO=1.-3.*C2T
      DELT1=DELTA
      DO 275 I=1,24
  275 PPERT(I)=ACCUM(I)
C
C      COMMON /AP3/ COMPLETED; SEND IT
C
C     CALL APPUT(DELT1,IAAP3,I2_27,I2_2)
C        COMMON /AP3/ ALREADY SHARED
      IU=3
      IF(LCOMP.NE.1) IU=4
      CALL REWFL(IU)
      JNEIG=0
      JTER=0
      JTYPE=1
      JSTAT=-1
C
C      COMMON /INTAP/ COMPLETED, SEND IT
C
C     CALL APPUT(JSTAT,IAINT,I2_16,I2_1)
C       COMMON /INTAP/ ALREADY SHARED
C
C      PROCESS SPHEROIDAL MODES
C
   47 CALL BFFIN(IU,1,KERBUF,8740,J,M)
C     CALL APPUT(KERBUF,IAAP2,I2_8740,I2_2)
C     CALL APWD
      DO 1252 I=1,8740
 1252 BKERN(I)=KERBUF(I)
C     CALL HROOT
C     CALL APWR
      CALL MODES
C
C      CHECK THE STATUS
C
C     CALL APGET(JSTAT,IAINT,I2_16,I2_1)
C     CALL APWD
      IF(JSTAT.EQ.0) GO TO 47
      IF(LCOMP.EQ.1) GO TO 200
C
C      PROCESS TOROIDAL MODES
C
      JSTAT=0
      JTYPE=2
      JNEIG=0
      JTER=0
C
C      SEND /INTAP/
C
C     CALL APPUT(JSTAT,IAINT,I2_16,I2_1)
   48 CALL BFFIN(4,1,KERBUF,8740,J,M)
C     CALL APPUT(KERBUF,IAAP2,I2_8740,I2_2)
C     CALL APWD
      DO 1253 I=1,8740
 1253 BKERN(I)=KERBUF(I)
C     CALL HROOT
C     CALL APWR
      CALL MODES
C
C      CHECK THE STATUS
C
C     CALL APGET(JSTAT,IAINT,I2_16,I2_1)
C     CALL APWD
C     CALL APWD
      IF(JSTAT.EQ.0) GO TO 48
C
C      COMPUTE THE INNER PRODUCT MATRIX AND THE COLUMN VECTOR
C
  200 JSTAT=1
      IF(JNSTR.GT.3) GO TO 201
      JPOINT=183
      JIFDEP=244
      GO TO 202
  201 JPOINT=I1
      JIFDEP=I2
C 202 CALL APPUT(JSTAT,IAINT,I2_16,I2_1)
  202 CONTINUE
C
C      SEND THE OBSERVED SEISMOGRAM
C
C     CALL APPUT(OBSEI,IAAP2,I2_514,I2_2)
C     CALL APWD
      DO 1254 I=1,514
 1254 BKERN(I)=OBSEI(I)
C     CALL MROOT
C     CALL APWR
      CALL MATRIX
C     CALL APGET(JSTAT,IAINT,I2_16,I2_1)
C
C      GET TMPPRD, TMPCOL, (OBSEIS)**2 & RMS
C
C     IADDR=IAAP2+1028
C     CALL APGET(TMPPRD,IADDR,I2_326,I2_2)
C     CALL APWD
      DO 1255 I=1,326
 1255 TEMBUF(I)=BKERN(I+1028)
      WRITE(6,1000) NNN,KK,NAME,LCOMP,RATE,RMS
 1000 FORMAT(' PATH=',I3,' ITER=',I2,' STATION ',A4,' COMP',I2,
     1' RATE',F5.0,' RMS=',E10.3)
C
C      STORE IF THE FIRST EVER
C
      IF(IFSTOR.NE.0.OR.KK.NE.1) GO TO 53
      IADDR=IAAP2+1028
C     CALL APGET(PRDMTX,IADDR,I2_325,I2_2)
C     CALL APWD
      DO 1256 I=1,325
 1256 BUFTEM(I)=BKERN(I+1028)
      CALL BFFO(7,1,B,5604,J,JREC)
C
C      IF LAST ITERATION, STORE THE ACCUMULATED PERTURBATION
C      AND THE SYNTHETIC SEISMOGRAM
C
   53 IF(KK.NE.NITER) GO TO 56
      IADDR=IAAP2+514
C     CALL APGET(COMP,IADDR,I2_514,I2_2)
C     CALL APWD
      DO 1257 I=1,514
 1257 COMP(I)=BKERN(I+514)
      DO 277 I=1,24
  277 PERT(I)=ACCUM(I)
      CALL BFFO(7,1,B,5604,J,JREC)
      WRITE(16,1000) NNN,KK,NAME,LCOMP,RATE,RMS
      IF(NITER.NE.1) GOTO 700
C
C      ACCUMULATE THE INNER PRODUCT MATRIX WITH AN APPROPRIATE WEIGHT
C
   56 IF(IFLAG.NE.0) GOTO 700
      WATE=1.
      IF(INST.EQ.3.AND.RATIOI.NE.0.) WATE=RATIOI**2
      IF(INST.EQ.3.AND.RATIOI.EQ.0.) WATE=.2E-12
      IF(INST.NE.3.AND.RATE.GT.20..AND.RATIOM.NE.0.) WATE=RATIOM**2
      LPAR=NPAR
      IF(JIFTWO.NE.0) LPAR=2*NPAR
      KNT=0
      DO 57 I=1,LPAR
      COLSUM(I)=COLSUM(I)+WATE*TMPCOL(I)
      IND=((2*NSOL-I)*(I-1))/2
      DO 57 K=I,LPAR
      KNT=KNT+1
      J=IND+K
   57 PRDSUM(J)=PRDSUM(J)+WATE*TMPPRD(KNT)
  700 CONTINUE
      IF(KK.NE.NITER) GO TO 811
      IF(NITER.EQ.1) CALL STRINV(NPAR,NSOL,NEVUS)
      IF(NITER.NE.1) GOTO 6
      DO 7 I=1,24
    7 PERT(I)=PERT(I)+PRTADD(I)
    6 CONTINUE
      WRITE(6,1002) NNN,NAME,NEVUS
      WRITE(16,1002) NNN,NAME,NEVUS
 1002 FORMAT(//' PATH',I3,' STATION ',A4,' EINVLS USED',I3)
      DO 114 I=1,NPAR
      IF(NPAR.EQ.NSOL) WRITE(6,1001) I,PERT(I)
      IF(NPAR.EQ.NSOL) WRITE(16,1001) I,PERT(I)
      IF(NPAR.NE.NSOL) WRITE(6,1001) I,PERT(I),PERT(I+NPAR)
      IF(NPAR.NE.NSOL) WRITE(16,1001) I,PERT(I),PERT(I+NPAR)
 1001 FORMAT(I5,2E15.5)
  114 CONTINUE
      GO TO 810
  811 CALL STRINV(NPAR,NSOL,NEVUS)
      DO 278 I=1,24
  278 ACCUM(I)=ACCUM(I)+PRTADD(I)
  810 CONTINUE
  800 CONTINUE
      RETURN
      END
